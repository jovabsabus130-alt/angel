        :root {
            --primary: #ff4d6d;
            --dark-pink: #ff0a54;
            --bg-grad: radial-gradient(circle, #ffb6c1, #ff9a9e, #fad0c4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Shantell Sans', cursive;
            background: var(--bg-grad);
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        canvas#particle-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 1; }

        .stage { display: none; flex-direction: column; align-items: center; width: 95%; max-width: 400px; z-index: 10; text-align: center; height: 100vh; justify-content: center; position: relative; }
        .stage.active { display: flex; }

        /* Stage 1: Buttons */
        .btn-container { display: flex; gap: 20px; margin-top: 20px; align-items: center; justify-content: center; min-height: 100px; width: 100%; }
        button { padding: 15px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-family: 'Shantell Sans'; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #yes-btn { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(255, 77, 109, 0.4); z-index: 10; font-size: 1.2rem; }
        #no-btn { background: white; color: var(--primary); border: 2px solid var(--primary); position: relative; z-index: 100; white-space: nowrap; }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(8px) rotate(5deg); }
            50% { transform: translateX(-8px) rotate(-5deg); }
            75% { transform: translateX(8px) rotate(5deg); }
            100% { transform: translateX(0); }
        }

        /* Stage 2: Heart & Slider */
        /* CENTERED GALLERY FIX */
        .heart-gallery { 
            position: relative; 
            width: 100%; 
            height: 350px; /* Constrained height */
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin: 20px 0;
        }

        .mini-polaroid { 
            position: absolute; width: 70px; height: 85px; background: white; padding: 4px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.2);
            z-index: 5; cursor: pointer; display: flex; flex-direction: column; align-items: center;
            /* Ensure centering starts from middle */
            left: 50%;
            top: 50%;
            margin-left: -35px; /* Half of width */
            margin-top: -42px;  /* Half of height */
        }

        .mini-polaroid img { width: 100%; height: 60px; object-fit: cover; pointer-events: none; }
        .mini-polaroid p { font-size: 0.4rem; margin-top: 3px; font-weight: bold; color: #555; overflow: hidden; white-space: nowrap; }

        .mini-polaroid.zoomed {
            position: fixed !important; top: 50% !important; left: 50% !important;
            width: 280px; height: 340px; z-index: 5000 !important;
            transform: translate(-50%, -50%) rotate(0deg) scale(1) !important;
            margin: 0 !important; /* Reset heart offsets */
            padding: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.4);
        }
        .mini-polaroid.zoomed img { height: 260px; }
        .mini-polaroid.zoomed p { font-size: 1rem; margin-top: 10px; }

        .swipe-wrap { width: 90%; opacity: 0; transform: translateY(20px); transition: 1s; margin-top: 10px; pointer-events: none; }
        .swipe-wrap.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .swipe-track { width: 100%; height: 55px; background: rgba(255,255,255,0.4); border-radius: 30px; position: relative; border: 2px solid white; overflow: hidden; }
        .progress-fill { position: absolute; left: 0; height: 100%; background: var(--primary); width: 0%; border-radius: 30px; pointer-events: none; }
        #heart-knob { position: absolute; left: 0; top: 0; width: 55px; height: 55px; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; z-index: 20; cursor: grab; touch-action: none; }

        /* Stage 3: Envelope & Letter */
        .envelope-wrapper { position: relative; width: 280px; height: 200px; z-index: 10; margin-bottom: 20px; }
        .envelope { width: 100%; height: 100%; background: var(--primary); position: relative; z-index: 5; cursor: pointer; border-radius: 0 0 10px 10px; }
        .lid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--dark-pink); clip-path: polygon(0 0, 50% 60%, 100% 0); transform-origin: top; transition: 0.8s; z-index: 10; border-radius: 10px 10px 0 0; }
        .envelope.open .lid { transform: rotateX(180deg); z-index: 1; }
        
        .card-scroll-wrapper { 
            position: fixed; top: 50%; left: 50%; width: 320px; height: 0; 
            background: #fffdfd; transition: 1.2s cubic-bezier(0.19, 1, 0.22, 1); 
            overflow-y: auto; z-index: 200; transform: translate(-50%, -50%);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); border-radius: 10px;
            opacity: 0; visibility: hidden;
        }
        .envelope.open + .card-scroll-wrapper { height: 550px; opacity: 1; visibility: visible; padding: 25px; }

        .scratch-container { margin: 20px auto; padding: 10px; border: 3px dotted var(--primary); border-radius: 15px; width: fit-content; background: #fff5f7; }
        .scratch-box { position: relative; width: 220px; height: 100px; background: white; border-radius: 8px; overflow: hidden; }
        #scratch-canvas { position: absolute; inset: 0; z-index: 2; touch-action: none; cursor: crosshair; }
        .secret-value { font-size: 2rem; color: var(--dark-pink); font-weight: 900; }
